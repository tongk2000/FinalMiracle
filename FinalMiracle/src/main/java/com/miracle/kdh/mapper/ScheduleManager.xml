<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== #7. mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- ==== #8. 루트 엘리먼트 & 네임스페이스 설정(프로젝트 전체내에서 유일해야 한다.) ==== -->              
<mapper namespace="do">
	<select id="getAllDoList" resultType="com.miracle.kdh.model.FolderVO">
		select idx, fk_teamwon_idx, subject, content
		     , to_char(startdate, 'yyyy-mm-dd') as startdate
		     , to_char(lastdate, 'yyyy-mm-dd') as lastdate
		     , fk_folder_idx, groupno, depth, category, status, importance
		     , case when trunc(startdate) <![CDATA[<]]> sysdate and sysdate <![CDATA[<]]> trunc(lastdate)+1 then 1
		            when trunc(lastdate)+1 <![CDATA[<]]> sysdate then -1
		            else 0 end as dayCnt
		from tbl_folder
		where status in (0, 1)
		start with fk_folder_idx = 0
		connect by prior idx = fk_folder_idx
		order siblings by category asc
	</select>
	
	<select id="getFolderInfo" resultType="com.miracle.kdh.model.FolderVO">
		select idx, fk_teamwon_idx, subject, content
		     , to_char(startdate, 'yyyy-mm-dd') as startdate
		     , to_char(lastdate, 'yyyy-mm-dd') as lastdate
		     , fk_folder_idx, groupno, depth, category, status, importance
		     , case when trunc(startdate) &lt; sysdate and sysdate &lt; trunc(lastdate)+1 then 1
		            when trunc(lastdate)+1 &lt; sysdate then -1
		            else 0 end as dayCnt
		     , (select avg(importance) from tbl_folder where groupNo = F.groupNo and idx != F.idx) as importanceAvg
		from tbl_folder F
		where idx = #{idx}
	</select>
	
	<select id="getFolder_teamwonInfo" resultType="com.miracle.kdh.model.Folder_TeamwonVO">
		select idx, fk_folder_idx, fk_teamwon_idx, acceptability, status
		     , (select userid from view_teamwonWithUserid where idx = fk_teamwon_idx) as userid
		     , getProceedingTaskCnt(fk_teamwon_idx,#{idx}) as proceedingTaskCnt
     		 , getCompleteTaskCnt(fk_teamwon_idx,#{idx}) as completeTaskCnt
		from tbl_folder_teamwon
		where fk_folder_idx = #{idx}
	</select>
	
	<select id="getFolder_commentInfo" resultType="com.miracle.kdh.model.Folder_CommentVO">
		select idx, fk_folder_idx, fk_teamwon_idx, content, status, to_char(writeDate, 'yyyy-mm-dd') as writeDate
		     , (select userid from view_teamwonWithUserid where idx = fk_teamwon_idx) as userid
		from tbl_folder_comment
		where idx = #{idx} and status = 1
		order by 1
	</select>
	
	<update id="goModalEdit" parameterType="com.miracle.kdh.model.FolderVO">
		update tbl_folder set subject=#{subject}, content=#{content}, startDate=to_date(#{startDate}), lastDate=to_date(#{lastDate}), importance=#{importance}
		where idx = #{idx}
	</update>
	
	<update id="setTaskComplete" parameterType="com.miracle.kdh.model.FolderVO">
		update tbl_folder set status = #{status}
		where idx = #{idx}
	</update>
	
	<resultMap type="HashMap" id="getUpFolder">
		<result property="groupNo" column="groupNo" javaType="String"/>
		<result property="depth" column="depth" javaType="String"/>
		<result property="subject" column="subject" javaType="String"/>
		<result property="fk_team_idx" column="fk_team_idx" javaType="String"/>
	</resultMap>
	<select id="getUpFolder" resultMap="getUpFolder">
		select groupNo, depth, subject, (select fk_team_idx from tbl_teamwon where idx = f.fk_teamwon_idx) as fk_team_idx
		from tbl_folder F
		where idx = #{upIdx}
	</select>
	
	<resultMap type="HashMap" id="getTeamwonList">
		<result property="userid" column="userid" javaType="String"/>
		<result property="idx" column="idx" javaType="String"/>
	</resultMap>
	<select id="getTeamwonList" resultMap="getTeamwonList">
		select userid, idx
		from view_teamwonwithuserid
		where fk_team_idx = #{fk_team_idx}
	</select>
</mapper>
















